<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book — Agentlyne</title>
  <meta name="description" content="Book a call with Agentlyne to map your voice AI reception or outbound workflow." />
  <meta name="theme-color" content="#00b8a9" />
  <meta name="color-scheme" content="dark light" />
  <link rel="canonical" href="https://agentlyne.com/book.html" />

  <!-- Favicons (file-based first, then inline fallback) -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Inline SVG fallback so a tab icon shows during cache weirdness -->
  <link rel="icon" sizes="any"
        href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="%2359d0ff"/><stop offset="1" stop-color="%238a5cff"/></linearGradient></defs><rect rx="14" width="64" height="64" fill="%230b1020"/><path d="M32 10l18 10v14c0 10-8 20-18 20S14 44 14 34V20z" fill="url(%23g)"/></svg>'>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Calendly (only used if CALENDLY_URL is configured) -->
  <link rel="preconnect" href="https://assets.calendly.com" crossorigin>
  <link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css">
  <script async src="https://assets.calendly.com/assets/external/widget.js"></script>

  <!-- Site config + shared styles -->
  <script src="/config.js"></script>
  <link rel="stylesheet" href="style.css" />

  <style>
    :root{ --brand-500:#00e0d8; --brand-600:#00b8a9; }
    body{ background:#f7f8ff; font-family: Manrope, ui-sans-serif, system-ui }
    .card{ background:#fff;border:1px solid rgba(2,8,23,.08);border-radius:20px;box-shadow:0 12px 32px rgba(2,8,23,.06) }
    .ring-brand{ box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--brand-500) 35%, transparent) }
    .btn{ display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:9999px;padding:.75rem 1.25rem;font-weight:700;transition:transform .15s, box-shadow .15s }
    .btn-primary{ color:#fff;background:linear-gradient(135deg,var(--brand-500),var(--brand-600));box-shadow:0 10px 28px color-mix(in oklab, var(--brand-600) 28%, transparent) }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 14px 34px color-mix(in oklab, var(--brand-600) 34%, transparent) }
    .btn-ghost{ border:2px solid rgba(2,8,23,.12); background:#fff; color:#0f172a }
    .chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:9999px; background:#fff; border:1px solid rgba(2,8,23,.12); color:#0f172a; font-weight:800 }
  </style>
</head>
<body class="text-slate-900">
  <div class="max-w-4xl mx-auto px-6 py-10">
    <header class="mb-8">
      <a href="pricing.html" class="text-slate-500 hover:text-slate-700">&larr; Back to Pricing</a>
      <h1 id="pageTitle" class="mt-2 text-4xl font-extrabold tracking-tight" style="font-family: Space Grotesk, Manrope, ui-sans-serif">Talk to sales</h1>
      <p id="pageSub" class="mt-2 text-slate-500">Tell us a bit about your business and pick a time.</p>
      <p class="mt-3">
        <span class="chip">Plan: <span id="chipPlan" class="font-extrabold">Inbound</span></span>
        <span class="chip">Tier: <span id="chipTier" class="font-extrabold">Starter</span></span>
      </p>
    </header>

    <div class="grid lg:grid-cols-5 gap-6 items-start">
      <!-- Calendly container (auto shown if CALENDLY_URL is set) -->
      <div id="calWrap" class="card p-0 overflow-hidden lg:col-span-3 hidden">
        <!-- Calendly will inject here -->
        <div id="calWidget"></div>
      </div>

      <!-- Sales form (fallback when Calendly not configured) -->
      <form id="bookForm" class="card p-5 lg:col-span-3" novalidate>
        <h2 class="text-xl font-extrabold">Book a call</h2>

        <!-- BANNER -->
        <div id="banner" class="hidden mb-4 rounded-xl border p-3 text-sm" aria-live="polite"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold">Full name</span>
            <input name="fullName" autocomplete="name" required class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold">Email</span>
            <input name="email" type="email" autocomplete="email" required class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold">Phone</span>
            <input name="phone" inputmode="tel" autocomplete="tel" class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold">Company</span>
            <input name="company" autocomplete="organization" class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm font-semibold">Date</span>
            <input name="date" type="date" required class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold">Time</span>
            <input name="time" type="time" required class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold">Time zone</span>
            <select name="timeZone" id="tz" required class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none"></select>
          </label>
        </div>

        <div class="mt-4">
          <label class="block">
            <span class="text-sm font-semibold">Notes</span>
            <textarea name="notes" rows="4" class="mt-1 w-full rounded-xl ring-brand px-3 py-2 outline-none" placeholder="Anything helpful (goals, tools, volume, etc.)"></textarea>
          </label>
        </div>

        <!-- Hidden context -->
        <input type="hidden" name="plan"   id="fPlan" />
        <input type="hidden" name="tier"   id="fTier" />
        <input type="hidden" name="intent" id="fIntent" />
        <input type="hidden" name="source" value="pricing" />

        <div class="mt-6 flex flex-wrap gap-3">
          <button class="btn btn-primary" id="bookBtn" type="submit">Book this time</button>
          <button class="btn btn-ghost" type="button" id="testSlot">Suggest times</button>
        </div>
      </form>

      <!-- Right column -->
      <aside class="card p-5 lg:col-span-2">
        <h3 class="text-lg font-bold">What happens next?</h3>
        <ul class="mt-3 space-y-2 text-sm">
          <li>• You’ll get a calendar invite by email (.ics attached).</li>
          <li>• We’ll join via Zoom or Google Meet.</li>
          <li>• Bring your flow and pain points—we’ll map quick wins.</li>
        </ul>
        <div class="mt-6 p-4 rounded-xl bg-slate-50 border border-slate-200">
          <strong class="block">Need a specific slot?</strong>
          <span class="text-slate-500">Use “Suggest times” and we’ll propose open slots automatically.</span>
          <div id="slotList" class="mt-3 grid gap-2"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const APP      = window.APP_CONFIG || {};
    const API_BASE = (APP.API_BASE ?? '').trim() || '';
    const SUPPORT  = APP.SUPPORT_EMAIL || 'info@agentlyne.com';
    const BRAND    = APP.BRAND_NAME || 'Agentlyne';
    const CAL      = (APP.CALENDLY_URL || '').trim(); // <- set this in /public/config.js

    const qs = new URLSearchParams(location.search);
    const PLAN   = (qs.get('plan')  || 'inbound').toLowerCase();
    const TIER   = (qs.get('tier')  || 'starter').toLowerCase();
    const INTENT = (qs.get('intent')|| `${PLAN}-${TIER}`);

    const api = p => `${API_BASE}${p}`;
    const banner = document.getElementById('banner');
    const form   = document.getElementById('bookForm');
    const btn    = document.getElementById('bookBtn');

    function setBanner(kind, text) {
      banner.className = "mb-4 rounded-xl border p-3 text-sm";
      if (kind === 'ok') {
        banner.classList.add('bg-emerald-50','border-emerald-200','text-emerald-700');
      } else if (kind === 'warn') {
        banner.classList.add('bg-amber-50','border-amber-200','text-amber-700');
      } else {
        banner.classList.add('bg-rose-50','border-rose-200','text-rose-700');
      }
      banner.textContent = text;
      banner.classList.remove('hidden');
    }
    function clearBanner(){ banner.className='hidden'; banner.textContent=''; }

    (function init(){
      document.title = `Book — ${BRAND}`;
      const cap = s => s ? s[0].toUpperCase()+s.slice(1) : s;
      document.getElementById('chipPlan').textContent = cap(PLAN);
      document.getElementById('chipTier').textContent = cap(TIER);
      document.getElementById('fPlan').value   = PLAN;
      document.getElementById('fTier').value   = TIER;
      document.getElementById('fIntent').value = INTENT;

      // Prefill helpful notes
      const pretty = INTENT.replace(/[-_]+/g,' ').replace(/\b\w/g,s=>s.toUpperCase());
      const notes = form.querySelector('textarea[name="notes"]');
      if (notes && !notes.value.trim()) {
        notes.value = `Requested: ${pretty}\n\nKey details:\n• Team size / call volume\n• CRMs / tools\n• Hours of coverage\n• Any compliance needs`;
      }

      // Time zone select
      const tzSelect = document.getElementById('tz');
      const current = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
      const zones = (Intl.supportedValuesOf && Intl.supportedValuesOf('timeZone')) || [current,'UTC'];
      [current, ...zones.filter(z=>z!==current)].forEach(z=>{
        const o=document.createElement('option'); o.value=o.textContent=z; tzSelect.appendChild(o);
      });

      // Calendly embed if configured
      if (CAL) {
        const calWrap = document.getElementById('calWrap');
        const calWidget = document.getElementById('calWidget');
        calWrap.classList.remove('hidden');
        form.style.display = 'none';

        // Color params
        const url = new URL(CAL);
        const params = url.searchParams;
        if (!params.has('primary_color'))    params.set('primary_color', '00b8a9');
        if (!params.has('text_color'))       params.set('text_color', '0f172a');
        if (!params.has('background_color')) params.set('background_color', 'f7f8ff');

        calWidget.className = 'calendly-inline-widget';
        calWidget.setAttribute('data-url', url.toString());
        calWidget.style.minWidth = '320px';
        calWidget.style.height   = '780px';
      }

      try{
        localStorage.setItem('agentlyne_plan', PLAN);
        localStorage.setItem('agentlyne_tier', TIER);
        localStorage.setItem('agentlyne_intent', INTENT);
      }catch{}
    })();

    // Native booking submit (fallback when Calendly is not used)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearBanner();

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.plan   = PLAN;
      payload.tier   = TIER;
      payload.intent = INTENT;
      payload.source = 'pricing';
      payload.duration = 30;

      btn.disabled = true; btn.textContent = 'Booking…';

      try {
        const r = await fetch(api('/api/book'), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let data = null; try { data = await r.json(); } catch {}
        if (!r.ok || !(data && data.ok === true)) {
          throw new Error((data && data.error) || `Request failed (${r.status})`);
        }

        setBanner('ok', 'Booked! Check your email for the confirmation.');
        form.reset();
        // restore hidden after reset
        document.getElementById('fPlan').value   = PLAN;
        document.getElementById('fTier').value   = TIER;
        document.getElementById('fIntent').value = INTENT;
      } catch (err) {
        console.error('book error:', err);
        setBanner('err', `Something went wrong. Please try again${SUPPORT ? ` or email ${SUPPORT}.` : '.'}`);
      } finally {
        btn.disabled = false; btn.textContent = 'Book this time';
      }
    });

    // Suggest slots demo (fallback)
    document.getElementById('testSlot').addEventListener('click', async ()=>{
      const tz = document.getElementById('tz').value || 'UTC';
      const today = new Date().toISOString().slice(0,10);
      const wrap = document.getElementById('slotList');
      wrap.innerHTML = '';
      try{
        const r = await fetch(api(`/api/slots?date=${today}&tz=${encodeURIComponent(tz)}`));
        const { slots = [] } = await r.json();
        if (!slots.length){
          const p = document.createElement('p'); p.className='text-xs text-slate-500';
          p.textContent='No suggestions for today. Try another date.'; wrap.appendChild(p); return;
        }
        slots.forEach(iso=>{
          const d = new Date(iso);
          const b = document.createElement('button');
          b.className='px-3 py-2 rounded-lg border hover:bg-slate-100 text-sm';
          b.type='button';
          b.textContent=d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          b.onclick=()=>{
            form.querySelector('input[name="date"]').value = d.toISOString().slice(0,10);
            form.querySelector('input[name="time"]').value = d.toISOString().slice(11,16);
            document.getElementById('tz').value = tz;
            wrap.innerHTML = '';
          };
          wrap.appendChild(b);
        });
      }catch(e){ console.error('/api/slots error', e); }
    });
  </script>
</body>
</html>
